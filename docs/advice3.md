双通道渲染：最小实现清单
0) 前置约定

单一 Renderer，同一个场景或两场景均可（推荐同一场景，按对象/灯光的 visible 切换）。

一次帧循环，两次 render：先月球、后地球。

不写 shader、不用 layers 做选择性照明。

1) 数据与参数

月相参数（由日期计算）：

sunDir_world：太阳方向（世界坐标）。

moonDir_from_sun or 相位角 phaseAngle（可选，用于自定义明暗边界/能见度）。

光照集：

Lights_Moon：只服务月球的“太阳光”（方向光即可）。

Lights_Earth：只服务地球的昼夜/城市灯/大气等。

环境光/IBL：避免全局 scene.environment；如果需要 IBL，分别在地球材质、月球材质上挂各自的 envMap。

2) 帧内顺序（关键）

清屏：启用 autoClear=true，本帧只在开始清一次（颜色+深度）。

月球通道

只开：月球网格 + Lights_Moon；关：地球网格 + Lights_Earth。

写入颜色+深度（正常不透明材质）。

目的：把“正确月相”的月球先画到帧缓冲里，并写好深度。

地球通道

切换可见：只开地球网格 + Lights_Earth；关掉月球网格/灯光。

不清除深度（保持上一步深度）；正常渲染地球与大气、云层等。

结果：月球已固定，不受地球光照影响；深度遮挡关系自然正确。

后期（可选）

若用后期合成（Bloom/色调映射），放在两次渲染之后统一做。

若希望只对地球做特别后期，需要改为两路 RenderPass 合成（此为扩展，不是最小实现）。

备注：如需“地球挡住月球”的场景（例如地球沿视线前方），上面的深度流程天然支持；若需“月球只投影不着色”这类特殊效果，再考虑第三个通道或在第二通道让月球“只写深度不写颜色”。

3) 对象与灯光的可见性切换

用 object.visible = true/false、light.visible = true/false，在两次渲染之间切换集合。

不建议临时改动材质（避免状态抖动/GC）。

4) 阴影策略

基础版：月球和地球相互不投影/不受影（castShadow=false/receiveShadow=false）——最省心。

进阶：若想“月球投影到地球”（如日食效果）：

仍用双通道，但在地球通道启用来自“太阳”的阴影；

月球需在地球通道参与阴影投射（可见性关闭、仅参与阴影图）。

这是扩展项，MVP 可暂不做。

5) IBL / 环境贴图

不使用 scene.environment（全局会影响两通道）。

在地球材质上单独挂 envMap_Earth；月球材质：

要“纯几何月相”→ 不挂 envMap；

若要些许反照/地球辉 → 自己评估贴合度后再加小权重的 envMap_Moon。

6) 透明层（大气/云/光晕）

大气散射、云层为半透明时，建议放在地球通道渲染，并注意：

深度写入：大气常 depthWrite=false 但 depthTest=true；

排序：保证透明对象排在不透明之后（three 默认做，但多通道时自己检查一次）。

7) 色彩与曝光一致性

两通道保持相同的色调映射/输出编码（ACES/Linear→sRGB 等）。

若月球使用自发光或无光材质，确保最终也走 renderer 的色调映射路径，避免“跳色”。

8) 性能与缓存

参数低频更新：日期改变才重算 sunDir_world/相位角；

可缓存：按日期哈希缓存月球贴图或“月球通道渲染结果”（如果你最后决定把月球通道烘进纹理再复用）。

同帧两次 render 对大多数场景开销可接受，且比改 shader 更易维护。

9) 验收用例（QA Checklist）

关闭所有地球灯光，地球应变黑；月球保持正确月相外观。

增加/删除地球灯光，对月球零影响。

切换 scene.environment，地球响应，月球零变化。

改日期 → 月相推进正确（朔→上弦→望→下弦）。

大气/云层透明时，与月球遮挡关系正确，无穿插边缘。

开关后期，色调一致，不出现双重 tone mapping。