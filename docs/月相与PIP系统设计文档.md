# 月相与PIP系统设计文档

## 系统架构概述

本系统采用"地球固定垂直 + 太阳方向反推"的独特架构，实现准确的月相变化和PIP（Picture-in-Picture）潮汐锁定展示。

## 核心设计思想

### 1. 地球固定垂直架构
- **地球姿态**：地球始终保持垂直放置（Y轴向上）
- **太阳光计算**：通过地球的反向旋转来反推太阳光方向
- **季相整合**：太阳光方向计算包含黄赤交角和季相变化
- **时间驱动**：通过日期时间变化驱动整个系统

### 2. 月相实现机制
- **真实月球自转**：月球1通过自转来面向太阳，实现月相变化
- **潮汐锁定面**：月球的同一个面始终朝向地球（潮汐锁定原理）
- **太阳光方向**：使用真实计算的太阳方向向量，包含季相变化
- **物理准确性**：月相变化基于真实的天文计算

### 3. PIP系统设计
- **相机2跟随机制**：PIP相机2跟随月球1的自转一并旋转
- **潮汐锁定视角**：相机2始终保持对月球潮汐锁定面的观察
- **独立渲染空间**：相机2渲染的月球可能不在主场景镜头1中显示
- **实时投射**：相机2拍摄的完整月球图像实时投射到主屏幕PIP窗口

## 技术实现要点

### 太阳光方向计算
```typescript
// 关键：太阳光方向必须考虑黄赤交角和季相变化
const sunDirWorld = calculateSunDirection(date, lat, lon, season);
// 包含：
// - 黄赤交角影响（23.44度）
// - 季相变化（春分、夏至、秋分、冬至）
// - 地球自转角度
// - 观测者经纬度
```

### 月球自转控制
```typescript
// 月球自转实现潮汐锁定和月相
moon.rotation = calculateMoonRotation(
  sunDirection,    // 真实太阳方向
  earthPosition,   // 地球位置
  moonPosition,    // 月球位置
  date            // 日期时间
);
```

### PIP相机跟随算法
```typescript
// PIP相机2跟随月球自转
pipCamera.position = calculatePipCameraPosition(
  moonPosition,      // 月球位置
  moonRotation,      // 月球自转角度
  tidalLockOffset    // 潮汐锁定偏移
);

// 相机始终保持对月球同一面的观察
pipCamera.lookAt(moonPosition);
```

## 分层渲染策略

### 场景分层
- **Layer 0**：主场景（地球、星空等）
- **Layer 1**：真实月球（可能对主相机隐藏）
- **Layer 2**：PIP投射平面

### 渲染流程
1. **主场景渲染**：相机1渲染Layer 0
2. **月球渲染**：相机2渲染Layer 1的月球
3. **FBO捕获**：将相机2的渲染结果捕获到纹理
4. **PIP显示**：在Layer 2上显示FBO纹理

## 关键技术挑战

### 1. 太阳光方向准确性
- 必须包含黄赤交角的周期性变化
- 季相变化对太阳方位的影响
- 地球自转与公转的耦合计算

### 2. 月球潮汐锁定
- 月球自转周期与公转周期同步
- 始终保持同一面朝向地球
- 同时要正确展现月相变化

### 3. PIP相机同步
- 相机2必须完美跟随月球自转
- 保持适当的观察距离和角度
- 确保潮汐锁定面始终可见

### 4. 渲染性能优化
- 避免重复渲染月球
- 合理的FBO分辨率设置
- 相机视锥体的优化配置

## 实现验证要点

### 功能验证
1. **月相准确性**：不同日期时间的月相是否正确
2. **潮汐锁定**：月球是否始终同一面朝向地球
3. **PIP同步**：相机2是否正确跟随月球自转
4. **季相影响**：太阳光方向是否随季相正确变化

### 性能验证
1. **渲染效率**：双相机渲染的性能影响
2. **内存使用**：FBO纹理的内存占用
3. **帧率稳定性**：实时渲染的流畅度

## 与传统方案的区别

### 传统方案
- 太阳围绕地球运转
- 月球围绕地球运转
- 直接模拟天体运动

### 本方案特点
- 地球固定垂直
- 反推太阳光方向
- 月球自转实现月相
- PIP相机跟随机制

## 开发指导原则

1. **物理准确性优先**：所有计算基于真实天文数据
2. **架构简洁性**：避免复杂的多层嵌套
3. **性能优化**：合理使用分层和渲染技术
4. **可扩展性**：为未来功能预留接口

---

*本文档记录了系统的核心设计思想，确保开发过程中始终保持正确的技术路线。*