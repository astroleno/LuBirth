# TODO · 出生纪念 · 地月合影

简洁版任务总览，跟踪当前状态、已交付与后续计划。用于低语模式同步：每项仅保留必要信息，便于快速确认与推进。

## 已完成（Done）
- 工程与基础
  - Vite + React + TypeScript + R3F（@react-three/fiber + drei）脚手架与运行链路。
  - astronomy-engine 接入（JS/TS 版），可计算 Sun/Moon 向量与月相（用于真实光照）。
- MVP 场景与交互
  - 极简 Earth/Moon 场景、星空、ACES 色调映射、轻半球光、环境光。
  - 大气辉光（Additive）轻量实现，边缘更柔和（可调）。
  - 面板：经纬度/时间输入；构图滑条（地球上沿、地球大小“占屏”、月球 X/Y、距离、半径）。
  - 构图内核（屏幕驱动）：
    - 地球大小以“屏幕占比”解析相机距离（直径/屏高恒定）。
    - 地球上沿位置以屏幕比例解析地球中心 y，支持到 0.8。
    - 月球以屏幕坐标反投影定位（与地球大小解耦）。
  - 模式切换：艺术构图 / 真实方位（光照）。
- 兼容与修复
  - R3F hooks 范围、未定义变量导致的黑屏修复。
  - Canvas 全屏固定与样式清理，减少滚动条/布局干扰。
  - 添加对齐辅助（中心十字 + 三分线）。
  - UI/DOM 右移问题修复：统一锚定 `.canvas-wrap`，避免滚动条/DevTools 影响中心。

- 光照与渲染结构（重要）
  - 拆分为“两套光照系统 + 两套渲染层”，最后一起呈现：
    - 地球系（layer 1）：地表（日/夜混合 Shader）、大气弧光、云层（受光照、可旋转）、标记点；仅受地球系平行光/半球光/环境光影响。
    - 月球系（layer 2）：月球网格；仅受月球系平行光/半球光/环境光影响。
    - 相机开启 layer[1,2] 一起显示；两套系统理论上互不影响（正在排查残余耦合）。

- 夜景与断层细化（第一阶段）
  - 终止线混合改为 f=smoothstep(-edge,edge, ndl+dither) 连续权重；加入轻微抖动减弱带状断层。
  - 夜面亮度按“离终止线距离”衰减（nightFalloff 默认 1.6），终止线附近更柔和。
  - 弧光贴合/强度/宽度可调，默认贴近并不联动色温。

- 云层系统（受光照、可控）
  - 云层采用受光照的 Shader，日侧更亮、夜侧衰减；支持强度、贴合高度、经度/纬度旋转；清晰度提升（各向异性 16）。
  - 当前默认：强度 0.35，贴合 0.01，经纬旋转 0°。
  
 追加（v0.1 定版）：
 - 云层厚度感：改为 Levels（黑点/白点/Gamma/对比度）+ Alpha 混合，厚处不透地、薄处叠加，强度响应明显。
 - 地光（径向渐隐）：新增日侧边缘“地光”层，仅在日侧边缘高亮，向外渐隐；强度/高度可调，避免整体包裹。
 - 黑屏根因修复：移除错误的双通道渲染循环（相机层置 0），恢复默认渲染；保留分层光照。

## 正在处理（In Progress）
- 两套光照系统彻底去耦
  - 目标：地球阳光强度仅影响地球；月球阳光强度仅影响月球；半球/环境光亦分别独立。
  - 手段：确保地球/云层/弧光/地表材质与其光源同层；月球及其光源仅在独立层渲染；相机启用多层但不共享光照。
- 夜景细化（第二阶段）
  - 暴露 nightFalloff/edge 作为滑块；引入小幅颜色 S 曲线，进一步抚平终止线附近细微断层。
- 云层表现稳定性
  - 检查与地表/弧光的混合与深度排序，避免“被冲淡/过浅”；必要时引入 Screen 混合或分离通道。
  - v0.1 已改为 Levels + NormalBlending，厚云不透地；后续与地光叠加继续观测。

## 下一步（Next Up）
- 真实方位（位置）最小偏置入框
  - 用 astronomy-engine 放置真实月亮方向；若出框，对月亮方向做最小角偏置，使其落入“上中窗口”（保持相位与光照真实）。
- 视觉细化
  - 曝光/伽马微调滑条；必要时加入轻量 FXAA/SMAA（可开关）。
  - 贴图开关：Earth 日间贴图（Blue Marble）、Moon 漫反射；默认仍保持极简（可一键关闭）。
- 月相实现（基于真实太阳方向）
  - 使用太阳方向计算月相光照，提供相位偏移微调；与地球光照一致但独立控制。
- 体验与导出
  - PNG 截图（2K），隐藏 UI 输出干净海报；移动端横屏验证与性能降级（星空数量/几何段数自适应）。
  - 构图参数本地持久化（localStorage）与“模板一键还原”。
- 文档
  - README 增补：模式说明、滑条含义与建议参数；已知问题与排查指南。

新增（解耦路线，验证中）：
- 分层解耦渲染·摄影（Dual-Canvas 方案）
  - 已在 `test/decoupled/` 搭建 DualCanvas 原型；通过 `?decoupled=1` 开关启用；先复用地球主场景 + 简化月相层分离。
  - 待办：相机/曝光严格同步；月球位置对齐屏幕坐标；导出合成（次优先）。

## 即将开始 · 解耦验证计划（仅在 `src/decoupled/` 内开发）
- CameraSync：从主线构图计算相机（fov/near/far/position/lookAt），同步至月球 Canvas，相机保持只读。
- MoonPlacement：按 `composition.moonScreenX/Y/dist` 将月球放入对应屏幕位置；仅用简化漫反射 + Sun→Moon 月相。
- Tone/Exposure：统一 toneMapping 与 exposure；必要时提供月球层匹配因子（默认与地球一致）。
- Toggle/Route：保留 `?decoupled=1` 开关；不得改动主线渲染逻辑，仅增量挂载。
- 文档：每完成一步更新本 TODO；评估通过后再考虑合并默认路径。

## 已交付（v0.1 补充）
- UI 折叠/展示：新增“折叠 UI/显示 UI”，截图时仅左上角按钮保留；支持 `?clean=1` 初始隐藏。
- 默认参数：支持“保存为默认”，`重置` 优先恢复保存的默认；可直接将 debug=1 下的参数固化为默认。

## 已知问题 / 待排查（Open Issues）
- 地球阳光强度仍偶发影响月球（耦合残留）：检查材质/光照收敛与层分配，必要时分两次渲染合成。
- 云层在特定角度“偏淡”：进一步校正混合/深度与亮度曲线；确认默认强度与日侧权重。
- 超大占比（>250%）时性能与边缘稳定性观察（已支持到 300%）。
- 极端参数边界：地球大小 > 0.8 与上沿接近 0.8 时的数值稳定性（需联调）。

## 验收要点（Checkpoints）
- 构图：地球上沿=屏幕 1/3 时稳定贴线；地球大小=目标百分比时视觉匹配；月球位于上半区且可按屏幕坐标精确定位。
- 模式：切到“真实方位（光照）”月相与终止线方向真实；切回“艺术构图”构图不变。
- 右移：中心十字位于屏幕几何中央；不随 DevTools/滚动条改变。（已修复）
- 光照：两套光照系统分别渲染但一起呈现；两套系统互不影响（强度/方向/环境/半球均独立），通过层或分次渲染合成实现。

## 待你确认/偏好（Owner Input）
- 上中窗口具体范围：例如 X=[0.45,0.55]，Y=[0.70,0.90]，用于真实月亮偏置入框的目标框。
- 是否启用贴图增强（默认关闭），以及希望的默认曝光/伽马基准。
- PNG 导出分辨率首选（2K/可变）。

---
更新节奏：每次推进后，我会用低语模式回填“完成 + 测试点”，你仅需回“OK/参数值”。此文档将持续同步。
