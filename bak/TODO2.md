# 月相计算与双通道渲染实现计划

## 项目目标
实现精确的月相计算和完全隔离的地月光照系统，采用"锁月+单通道复用"的优化架构。

## 技术方案
- **月相计算**：基于真实天文计算的精确月相
- **渲染架构**：锁月+单通道复用（月球低频更新，地球高频更新）
- **光照隔离**：月球完全不受地球光照影响

---

## ✅ 已完成工作

### 模式重构（基础架构）
- [x] 将模式从 `'art' | 'real'` 重构为 `'debug' | 'celestial'`
- [x] 实现天相模式（基于真实天文数据）和调试模式（参数自由调整）
- [x] 实现参数分离存储（天相模式：`luBirth.celestial`，调试模式：`luBirth.debug`）
- [x] 实现天相模式下的参数联动（时间变化自动更新光照参数）
- [x] 优化月球贴图对齐（月球经度调整默认值 -90°，删除重复控制）

### 天相模式实现
- [x] 基于真实天文数据计算太阳和月球光照方向
- [x] 自动更新 `earthLightAzDeg`、`earthLightElDeg`、`moonAzDeg`、`moonElDeg`
- [x] 启用独立月球光照系统
- [x] 时间变化时自动联动参数更新

---

## 第一阶段：双通道渲染架构（核心实现）

### 1.1 RenderTarget系统
- [x] 创建月球RenderTarget（自适应分辨率）
- [x] 实现月球通道渲染逻辑
- [x] 实现地球通道渲染逻辑
- [x] 设置渲染顺序：月球通道 → 地球通道

### 1.2 可见性切换系统
- [x] 实现月球对象和光照的visible切换
- [x] 实现地球对象和光照的visible切换
- [x] 优化切换性能（避免频繁创建/销毁）

### 1.3 缓存机制
- [x] 实现月球渲染结果缓存
- [x] 实现日期变化检测机制
- [x] 实现月球纹理的缓存更新

### 1.4 集成和测试
- [x] 创建双通道渲染管理器组件
- [x] 集成到主场景中
- [x] 添加双通道渲染参数到Composition类型
- [x] 创建测试页面验证功能
- [x] 修复UI控制选项的语法错误
- [x] 修复TypeScript类型定义问题
- [x] 验证页面可以正常加载
- [x] 修复双通道渲染器中的layers错误处理
- [x] 确保双通道渲染默认关闭，避免黑屏问题
- [x] 优化双通道渲染性能，只在初始化时渲染一次，避免每帧重复渲染
- [x] 修复layers检查方式，使用正确的mask位运算
- [x] 改为参数变化时触发渲染，而不是每帧渲染
- [x] 修复WebGLRenderTarget的colorSpace警告
- [x] 移除Canvas频繁重新挂载的调试日志
- [x] 修复RenderTarget频繁创建和销毁的问题，只在启用状态改变时创建
- [x] 修复App.tsx中的循环依赖问题，避免频繁重新渲染
- [x] 实现真正的分层渲染：使用Three.js的layer系统，月球完全不受地球光照影响
- [x] 修复贴图不显示问题：移除材质的layer设置，使用可见性切换确保贴图正常显示
- [x] 实现月球烘焙方案：创建MoonBaker组件，将月球渲染为静态纹理，完全隔离地球影响
- [x] 调试渲染系统：添加绿色测试立方体，检查底层渲染是否正常
- [x] 测试Canvas渲染：直接在Canvas中添加测试立方体，绕过MoonOverlay组件
- [x] 修复遮罩位置计算：发现月球位置通过屏幕坐标计算，创建MoonOverlayWrapper组件
- [x] 同步遮罩位置：使用与月球相同的位置计算逻辑，确保遮罩与月球重叠
- [x] 修复遮罩Z坐标问题：发现遮罩Z坐标为负数，简化位置计算确保在相机前面
- [ ] 测试月球烘焙效果和性能
- [ ] 优化烘焙纹理的质量和分辨率

### 1.5 月球烘焙方案（新增）
- [x] 创建MoonBaker组件，实现月球独立渲染和烘焙
- [x] 集成月球烘焙功能到SceneContent组件
- [x] 添加月球烘焙控制选项到UI
- [x] 实现烘焙纹理的材质切换逻辑
- [x] 修复烘焙纹理创建错误，避免WebGL texSubImage2D错误
- [x] 实现双层材质系统：烘焙材质和展示材质分离
- [x] 添加月球高度贴图支持，提升月球表面真实感
- [x] 添加高度贴图强度控制选项
- [x] 修复高度贴图默认值为0.02
- [x] 实现圆形遮罩系统：烘焙纹理作为圆形遮罩覆盖月球，而不是直接替换材质
- [x] 修复月球展示材质中的语法错误（重复else语句）
- [x] 修复遮罩大小匹配：遮罩比月球稍大（2.2倍半径）
- [x] 修复WebGL反馈循环：克隆烘焙纹理避免渲染循环
- [x] 优化遮罩着色器：正确显示烘焙纹理内容
- [x] 重新设计遮罩系统：简化为半透明黑色遮罩，避免烘焙纹理显示问题
- [x] 修复WebGLRenderTarget配置：添加深度缓冲和深度纹理
- [x] 修复遮罩渲染层级：设置renderOrder确保遮罩在最前面
- [x] 修复烘焙光照控制：烘焙时关闭地球光，只使用月球光
- [x] 实现真正的烘焙纹理遮罩：烘焙结果作为圆形投影图挡在月球前
- [x] 修复renderOrder错误：使用mesh的renderOrder而不是材质的
- [x] 修复烘焙默认值：moonBakingEnabled默认为false
- [x] 修复遮罩位置绑定：使用useFrame实时更新遮罩位置与月球同步
- [x] 修复WebGL纹理错误：禁用mipmap生成，使用更安全的纹理创建方式
- [x] 强制清除localStorage中的烘焙设置：确保默认关闭状态
- [x] 修复遮罩透明度：设置为不透明，启用深度测试和深度写入
- [x] 添加烘焙调试信息：检查月球对象和光照的可见性状态
- [x] 添加显示烘焙遮罩的独立开关：moonOverlayEnabled
- [x] 修复遮罩受光照影响：使用MeshBasicMaterial替代ShaderMaterial，天然不受光照影响
- [x] 修复遮罩渲染位置：将遮罩移到双通道渲染器外部，确保独立渲染
- [x] 调试遮罩可见性：调整Z轴位置，增大遮罩尺寸，添加调试信息
- [ ] 测试月球烘焙效果和性能
- [ ] 优化烘焙纹理的质量和分辨率

---

## 第二阶段：月相计算系统（基础实现）

### 2.1 月相计算核心
- [ ] 实现太阳方向向量计算（基于现有astronomy-engine）
- [ ] 实现观察方向向量计算（相机到月球方向）
- [ ] 实现相位角计算：cos i = dot(Ŝ, Ô)
- [ ] 实现照亮比例计算：k = (1 + cos i) / 2
- [ ] 实现明暗边界方向计算

### 2.2 月相参数集成
- [ ] 在现有月球光照计算中集成月相参数
- [ ] 添加月相相关的uniforms到月球材质
- [ ] 实现月相参数的实时更新机制

### 2.3 月相渲染测试
- [ ] 测试不同日期的月相变化（朔→上弦→望→下弦）
- [ ] 验证月相计算的准确性
- [ ] 测试相机旋转时月相的一致性

---

## 第三阶段：渲染优化（性能提升）

### 3.1 分辨率自适应
- [ ] 根据月球屏占比调整RenderTarget分辨率
- [ ] 实现分辨率切换阈值（120px, 60px等）
- [ ] 优化小月球时的渲染性能

### 3.2 色调映射一致性
- [ ] 确保月球通道和地球通道的色调映射一致
- [ ] 实现色彩空间的一致性
- [ ] 避免烘焙结果和主渲染的色彩偏差

### 3.3 深度和遮挡
- [ ] 确保月球和地球的正确遮挡关系
- [ ] 实现深度写入的一致性
- [ ] 处理透明层的渲染顺序

---

## 第四阶段：高级效果（可选扩展）

### 4.1 地球辉效果
- [ ] 实现地球辉（Da Vinci glow）效果
- [ ] 在月相很小时给暗面添加极弱光照
- [ ] 模拟地球反照到月球的效果

### 4.2 月球天平动
- [ ] 实现月球天平动（libration）效果
- [ ] 添加经度和纬度方向的小角度摆动
- [ ] 模拟月球边缘特征的露出/隐藏

### 4.3 食相效果
- [ ] 实现月球在地球上的投影
- [ ] 实现日食/月食效果
- [ ] 处理食相时的特殊光照

---

## 第五阶段：性能监控和优化

### 5.1 性能监控
- [ ] 添加渲染时间统计
- [ ] 监控内存使用情况
- [ ] 实现性能瓶颈检测

### 5.2 缓存优化
- [ ] 实现月相参数的智能缓存
- [ ] 优化纹理内存管理
- [ ] 实现预计算机制（相邻日期）

### 5.3 用户体验优化
- [ ] 实现无感知的月相切换
- [ ] 优化快速日期切换的性能
- [ ] 添加加载状态指示

---

## 验收标准

### 功能验收
- [ ] 月相计算准确（与真实天文数据对比）
- [ ] 光照完全隔离（地球光照不影响月球）
- [ ] 性能满足要求（99%帧数只有一次渲染）
- [ ] 视觉效果一致（色调映射、色彩空间）

### 性能验收
- [ ] 月球渲染缓存有效（日期不变时无重复渲染）
- [ ] 内存使用合理（RenderTarget大小适中）
- [ ] 渲染性能稳定（无明显卡顿）

### 兼容性验收
- [ ] 与现有地球渲染系统兼容
- [ ] 与现有UI控制系统兼容
- [ ] 与现有天文计算系统兼容

---

## 技术风险与应对

### 风险1：Three.js版本兼容性
- **风险**：不同版本的layer系统行为可能不同
- **应对**：充分测试目标版本，准备降级方案

### 风险2：性能瓶颈
- **风险**：双通道渲染可能影响性能
- **应对**：实现性能监控，优化渲染策略

### 风险3：视觉效果不一致
- **风险**：月球和地球的视觉效果可能不匹配
- **应对**：确保色调映射和色彩空间的一致性

---

## 开发优先级

**高优先级**：第一阶段 + 第二阶段
- 双通道渲染架构
- 月相计算系统
- 基础缓存机制

**中优先级**：第三阶段
- 渲染优化
- 性能提升
- 用户体验优化

**低优先级**：第四阶段
- 高级效果
- 扩展功能
- 可选特性

---

## 预计时间线

- **第一阶段**：2-3周
- **第二阶段**：1-2周  
- **第三阶段**：1-2周
- **第四阶段**：2-3周（可选）
- **第五阶段**：1周

**总计**：7-11周（约2-3个月）

---

## 成功指标

1. **功能完整性**：月相计算准确，光照完全隔离
2. **性能表现**：99%的帧数只有一次渲染
3. **用户体验**：月相切换流畅，视觉效果一致
4. **代码质量**：模块化设计，易于维护和扩展

## 待解决问题

### 遮罩位置和大小问题
- [ ] **重新分析月球位置**：明天需要根据月球的实际位置、大小和呈现方式来正确设置遮罩
- [ ] **遮罩与月球对齐**：当前遮罩位置计算可能不准确，需要重新分析月球的屏幕坐标和世界坐标转换
- [ ] **遮罩大小匹配**：遮罩大小需要精确匹配月球的视觉大小
- [ ] **遮罩呈现方式**：确保遮罩以正确的方式覆盖月球

### 当前状态
- ✅ 渲染系统正常工作（红色遮罩可见）
- ✅ 圆形遮罩形状正确
- ❌ 遮罩位置和大小与月球不匹配
- ❌ 遮罩可能没有正确覆盖月球

### 明天计划
1. 分析月球的实际渲染位置和大小
2. 重新设计遮罩的位置计算逻辑
3. 确保遮罩与月球完美对齐
4. 测试遮罩的覆盖效果

## 月球位置和大小计算方式分析

### 月球位置计算
**屏幕坐标**：
```typescript
const moonScreen = { 
  x: comp?.moonScreenX ?? 0.5,  // 默认屏幕中央
  y: comp?.moonScreenY ?? 0.78, // 默认屏幕上方
  dist: moonDistance            // 默认14
};
```

**世界坐标计算**：
```typescript
const moonPos = React.useMemo(() => {
  const ndc = new THREE.Vector3(moonScreen.x * 2 - 1, moonScreen.y * 2 - 1, 0.5);
  const p = ndc.unproject(camera);
  const dir = p.sub(camera.position).normalize();
  return camera.position.clone().add(dir.multiplyScalar(moonScreen.dist));
}, [camera, moonScreen.x, moonScreen.y, moonScreen.dist]);
```

### 月球大小
**几何体大小**：
```typescript
<sphereGeometry args={[moonRadius, 64, 64]} />
// moonRadius = comp.moonRadius ?? 0.44
```

### 相机配置
**相机设置**：
```typescript
<Canvas
  camera={{ position: [0, 0, 12], fov: 35 }}
  // 相机位置：z=12
  // 视野角度：35度
/>
```

### 关键发现
1. **月球使用unproject计算**：这是正确的3D位置计算方法
2. **我们的遮罩计算错误**：我们使用了简化的计算，应该使用相同的unproject方法
3. **月球半径是0.44**：这是世界单位的大小

### 修复方案
我们应该在MoonOverlayWrapper中使用与月球完全相同的位置计算：
```typescript
const moonPosition = React.useMemo(() => {
  const ndc = new THREE.Vector3(moonScreen.x * 2 - 1, moonScreen.y * 2 - 1, 0.5);
  const p = ndc.unproject(camera);
  const dir = p.sub(camera.position).normalize();
  return camera.position.clone().add(dir.multiplyScalar(moonScreen.dist));
}, [camera, moonScreen.x, moonScreen.y, moonScreen.dist]);
```

这样遮罩就会与月球在完全相同的位置！

- [ ] 实现烘焙纹理功能：将红色遮罩替换为烘焙的月球纹理
- [ ] 测试月球烘焙效果和性能
- [ ] 优化烘焙纹理的质量和分辨率
